---
title: "ttests rush contributions"
author: "Lydia White"
date: "`r Sys.Date()`"
output:
   html_document:
     toc: true
     toc_float: true
     code_folding: hide
---
```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE, message=FALSE, warning=FALSE)

```

calculation of consumer contributions to stability and significance testing 

```{r input data}

library(readr)
data <- read_csv(here::here("data","RUSH_MACRO_Concise.csv"))

```

```{r libraries, message=FALSE}
library(tidyverse)
library(vegan)
library(lsmeans)
library(emmeans)
library(car)
library(lme4)
library(lmerTest)
library(ggh4x)
library(patchwork)
library(ggpubr)
```

# Intact communities 

First we can explore community responses to stressors. Can explore intact communities immediately after distubance period (so month 12)

Treatments:
A	Algae
B	Algae & Grazers
C	Algae, Grazers & Whelks 
D	Uncaged control plot 

N0	No Nutrients 
N1	Enriched with Nutrients 
S0	No Sediment
S1	Sediment added

Functional responses are based on total percentage cover of all algal species as a proxy for biomass. Total percentage cover values often exceeded 100% due to the multi-layered nature of macroalgal communities. 

```{r summarise cover data, }
data$Plot <- gsub("24\\*", "100", data$Plot)

cols <-data %>% select(Fuc_Ves:Hilden) # columns of interest i.e. species

functional<- data%>%
  mutate_if(is.numeric, ~replace(., is.na(.), 0))%>%
   mutate(sum = rowSums(cols)) %>%
   select(Time:Treatment,sum) %>%
    filter(Time > 5 ) %>%
    rename(TAC = `sum`)

```

We compare total algal cover for disturbance treatments. 

```{r intact communities, }

intact<- functional%>%separate(Treatment, c("Diversity", "Nutrients","Sediment"), remove = F)%>%
  unite(Disturbance,c("Nutrients","Sediment"),sep="_")%>%
  filter(Disturbance != "N1_S1")%>% 
  filter(Time == 12 & Diversity == 'C')%>%
  mutate(Disturbance = as_factor(Disturbance))
  
  
ggplot(intact, aes(x=Disturbance, y=TAC))+
  geom_boxplot(aes(fill = Disturbance))+
  scale_fill_manual(values = c("#999999", "#FFCC00","#66CC00"))+
  theme_classic()
 

mod1<-lm(TAC~Disturbance, data = intact)

par(mfrow=c(2,2))
plot(mod1)
par(mfrow=c(1,1))
anova(mod1)

```

# Functional stability

Functional stability is calculated using total percentage cover of all algal species as a proxy for biomass. Total percentage cover values often exceeded 100% due to the multi-layered nature of macroalgal communities. To calculate stability values we are only interested in data following the perturbation, month 6 onwards. 

## Stability metrics

We calculate 4 different metrics using total algal cover data from the time period following the perturbations (months 6 to 15). 

### Temporal variability 

Temporal variability is calculated as the coefficient of variance (CV; that is, standard deviation divided by the mean) of total algal cover in each experimental plot over time during the pertubation phase. Detrended to remove potentially confounding effects of biomass change over the duration of the experiment.

We run linear models on total algal cover in each plot over time and use the residuals from these models to calculate the CV

```{r format data }

tmp<-functional%>%
  select(Diversity,Plot,Time, TAC,Treatment)%>%
  filter(Time < 13)

tmp = split(tmp,tmp$Plot)  

resids<-lapply(names(tmp),function(X){
  Y <- tmp[[X]]
  A <-residuals(lm(TAC~Time, data = Y))
  B <-Y$Diversity
  B2<-Y$Treatment
  C <-Y$Time
  D <-Y$TAC
  E <-sd(A)/mean(D)
  data_frame(Plot=X,Residuals=A, Diversity=B, Treatment = B2, Time=C, TAC =D, Temp.Var=E)
})

Temp_Var<-lapply(resids,function(X){
  X[1,]
}) %>% 
  Reduce("rbind",.)%>% 
  select(Plot,Diversity,Treatment,Temp.Var)

```

### Spatial variability 

Spatial variability was calculated as the CV of total algal cover among 
experimental plots within each stressor vs. consumer loss treatment combination on each census during the pertubation phase. Detrended to remove potentially confounding effects of biomass change over the duration of the experiment. 

So we use the residuals from the previous linear regressions. 
This time we divide SD of the residuals across plots for each time period by the mean total algal cover. 

```{r}

Spatial_Var<- Reduce("rbind",resids)%>%
  select(Time,Plot,Diversity,Treatment, Residuals,TAC)%>%
  group_by(Time, Diversity, Treatment) %>%
  summarise(Spa.Var = sd(Residuals)/mean(TAC))
  
```

### Resistance

Resistance and resilience are associated with a perturbation, they can only be calculated by comparing algal cover in perturbed treatments to cover within unperturbed treatments. 

Resistance was defined as the log response ratio (LRR) of total algal cover in a perturbed relative to unperturbed plot at th end of the perturbation phase. We calculated the LRR of total algal cover in each perturbed plot relative to the mean cover in unperturbed plots for the corresponding consumer loss treatment, for the final time point (month 12) during the perturbation phase (months 6 - 12). 

```{r}
mean_cover<-functional %>%
   filter (Time == 12 & Nutrients == 'N0' & Sediment == 'S0') %>%
  group_by(Diversity, Time)%>%
  summarise(meanTAC = mean(TAC))
  
cover<-functional %>%
   filter (Time == 12 ) %>%
  select(Diversity,Treatment,Time,Plot,TAC)


LRR_Resist<-left_join(cover,mean_cover)%>%
  mutate(LRR_TAC = log(TAC/meanTAC))%>%
  filter(Treatment != 'A_N0_S0' & Treatment != 'B_N0_S0' & Treatment != 'C_N0_S0' &   Treatment != 'D_N0_S0')%>%
  rename(Resist = LRR_TAC)%>%
 select(Plot, Diversity, Treatment, Resist)

```

### Resilience

Resilience is the slope of linear regression of the log response ratio over time from the end of the pertubation phase to the end of the experiment. Calculating the log difference is equivalent to calculating the rate of relative return, rather than the absolute rate, rendering resilience at least conceptually independent from resistance. 
So we run a lm on LRR in between months 12 and months 15.

```{r}
mean_cover<-functional %>%
   filter (Time > 11 & Nutrients == 'N0' & Sediment == 'S0') %>%
  group_by(Diversity, Time)%>%
  summarise(meanTAC = mean(TAC))

cover<-functional %>%
   filter (Time > 11) %>%
  select(Diversity,Treatment,Time,Plot,TAC)

LRR<-left_join(cover,mean_cover)%>%
  mutate(LRR_TAC = log(TAC/meanTAC))
  
Resil<-lapply(1:nrow(LRR_Resist),function(i){
  X = LRR_Resist[i,]
  tmp =  filter(LRR,Plot == X$Plot)
  tmp<-lm(LRR_TAC~Time,data = tmp)
  coef2 = tmp$coefficients["Time"]
  data_frame(Plot=X$Plot,Resilience=coef2)
})%>% Reduce("rbind",.)

```

We can compile all the stabilty measures. For the few cases where perturbations increased biomass and, therefore, resulted in a positive resistance value, resilience was then multiplied by -1.  We can plot the raw stabilty measures as boxplots. 

```{r, fig.height=10}

Stability_metrics<-left_join(LRR_Resist,Resil)%>%
  mutate(Resilience = ifelse(Resist >0, Resilience*-1, Resilience))%>%
  select(Plot,Diversity,Treatment,Resist,Resilience)%>%
  gather(key = metric, value = value, -Diversity, -Treatment, -Plot)%>%
  rename(rep = Plot)

Temp_Var<-Temp_Var%>%
gather(key = metric, value = value,  -Diversity, -Treatment, -Plot)%>%
rename(rep = Plot)

Spatial_Var<-Spatial_Var%>%
gather(key = metric, value = value,  -Diversity, -Treatment, -Time)%>%
rename(rep = Time )%>%
ungroup(rep)%>%
mutate(rep = as.factor(rep))

x <-rbind(Stability_metrics, Temp_Var,data.frame(Spatial_Var))%>% 
  filter(Diversity != "D")%>% 
  separate(Treatment, c("Diversity", "Nutrients","Sediment"), remove = F)%>%
  unite(Disturbance,c("Nutrients","Sediment"),sep="_")%>%
  filter(Disturbance != "N1_S1")%>% 
  mutate(metric = factor(metric,levels = c( "Temp.Var", "Spa.Var", "Resist", "Resilience")))%>%
  mutate(Disturbance = plyr::mapvalues(Disturbance, from = c("N0_S0","N0_S1","N1_S0"), to = c("Ambient","Sediment","Nutrients")))%>%
  mutate(Disturbance = factor(Disturbance,levels = c("Ambient", "Sediment","Nutrients")))%>%
  mutate(Diversity = plyr::mapvalues(Diversity, from = c("A","B","C"), to = c("Whelks & Grazers","Whelks","None")))%>%
  mutate(Diversity = factor(Diversity,levels = c("Whelks & Grazers","Whelks","None")))

A <-ggplot(data = subset(x, 
              metric == "Temp.Var"), aes(x=Diversity, y=value)) + 
  geom_boxplot(aes(fill = Disturbance)) + 
  theme_classic()+
  scale_y_reverse(limits = c(1, 0), breaks = seq( 0,1, by = 0.2))+ 
  ylab("Temporal variability") +
  scale_fill_manual(values = c("#999999", "#FFCC00","#66CC00"))

C<-ggplot(data = subset(x, 
              metric == "Spa.Var"), aes(x=Diversity, y=value)) + 
  geom_boxplot(aes(fill = Disturbance)) + 
  theme_classic()+
  ylab("Spatial variability") +
  ylim(0,0.5) +
  scale_fill_manual(values = c("#999999", "#FFCC00","#66CC00"))

E<-ggplot(data = subset(x, 
              metric == "Resist"), aes(x=Diversity, y=value)) + 
  geom_boxplot(aes(fill = Disturbance)) + 
  theme_classic()+
  ylab("Resistance") +
  ylim(-3,1.5) +
  scale_fill_manual(values = c("#FFCC00","#66CC00")) 

G<-ggplot(data = subset(x, 
              metric == "Resilience"), aes(x=Diversity, y=value)) + 
  geom_boxplot(aes(fill = Disturbance)) + 
  theme_classic()+
  ylab("Resilience") +
  xlab("Consumers removed") +
  ylim(-0.9,0.3) +
  scale_fill_manual(values = c("#FFCC00","#66CC00")) 

P_Func <- ggarrange(A + rremove("xlab") + rremove("x.text"), C + rremove("xlab") + rremove("x.text"),E + rremove("xlab") + rremove("x.text"), G, heights = c(1, 1,1,1), ncol = 1, nrow = 4,common.legend = T, labels = c("(a)", "(b)", "(c)", "(d)"))

annotate_figure(P_Func, left = text_grob("Functional stability", rot = 90))

```

## Consumer contributions

Contributions of grazers and predators to algal stability were then quantified as the inverse of the calculated stability metrics, that is, a strong destabilizing effect of a perturbation in plots from which a consumer group was removed compared to when it was present implies that the species contributes strongly and positively to that component of ecological stability. 

So we calculate the log response ratio of the stability metrics in a consumer group loss plot relative to plots when all consumers are present. i.e. predator loss treatments relative to no consuer losses (to evaluate net contribution of predators) and grazer & predator loss relative to predator loss (to evaluate net contribution of grazers). 

```{r species contributions, message = FALSE, warning=FALSE}

rangestand<-function(x) { 
  (x - min(x))/(max(x)-min(x))
} 

contributions <-rbind(Stability_metrics, Temp_Var,data.frame(Spatial_Var))%>%
  group_by(metric)%>%
  mutate(value = ifelse(metric == "Resist"|metric == "Resilience", rangestand(value)+0.01, value)) 

mean_metric<- contributions %>%
  filter(Diversity== "C"|Diversity== "B")%>%
  group_by(metric, Treatment)%>%
  summarise(mean =mean(value))

mean_metric$Treatment<- gsub("B", "A", mean_metric$Treatment)%>% 
  gsub("C", "B", .)

contributions<-left_join(contributions,mean_metric)%>%
  filter(Diversity == 'A' | Diversity == 'B')%>%
  mutate(LRR_metric = log(value/mean))

```

We can plot these consumer contributions as mean and errors.
To ensure that all stability metrics can be interpreted similarly when represented graphically, i.e. with a high positive value indicating the consumer promotes stability and an increasingly negative value indicating the consumer destabilises the system, resistance and spatial variability, and resilience are multiplied by -1 (as for these metrics a high positive value is associated with increased stability). 

```{r}
contributions <- contributions %>%
  mutate(LRR_metric = ifelse(metric == "Resilience"|metric == "Resist"|metric == "Spa.Var", LRR_metric*-1, LRR_metric))
 
summary<-contributions %>%
  group_by(Treatment,metric)%>%
  summarise(mean=mean(LRR_metric),  sd = sd(LRR_metric), n = n())%>%
  mutate(se = sd/sqrt(n),lower.ci = mean - qt(1 - (0.05 / 2), n - 1) * se, upper.ci = mean + qt(1 - (0.05 / 2), n - 1) * se)%>%
  separate(Treatment, c("Diversity", "Nutrients","Sediment"))%>%
  unite(Disturbance,c("Nutrients","Sediment"),sep="_")%>%
  filter(Disturbance !='N1_S1')%>%
  mutate(metric = factor(metric,levels = c( "Temp.Var", "Spa.Var", "Resist", "Resilience")))%>%
  mutate(Diversity = factor(Diversity,levels = c("B", "A")))%>%
  mutate(Diversity = plyr::mapvalues(Diversity, from = c("B","A"), to = c("Whelks","Grazers")))%>%
  mutate(Disturbance = plyr::mapvalues(Disturbance, from = c("N0_S0","N0_S1","N1_S0"), to = c("Ambient", "Sediment","Nutrients")))%>%
 mutate(Disturbance = factor(Disturbance,levels = c("Ambient", "Sediment","Nutrients")))

sum_Func<-ggplot(summary, aes(x=metric, y=mean, Diversity)) + 
  geom_errorbar(aes(colour = Disturbance, shape = Diversity, ymin=lower.ci, ymax=upper.ci),      position=position_dodge(0.85), width = 0.5, size = 0.7) +
  geom_point(aes(colour = Disturbance, shape = Diversity),position=position_dodge(0.85), size = 3)+
  ylab("Functional stability") +
  geom_hline(yintercept = 0, linetype="dashed") +
  theme_classic(base_size = 18)+
  theme(axis.text.x=element_text(angle=20,hjust=1),legend.position = "bottom", legend.title=element_text(size=8),legend.text = element_text(size=8)) + 
  annotate("text", x = 0.5, y = -1, label="Destabilizing", color = "black",size = 4, angle=90,fontface = "italic")+
  annotate("text", x = 0.5, y = 1, label="Stabilizing", color = "black",size = 4, angle=90,fontface = "italic")+
  scale_colour_manual(values=c("#999999", "#FFCC00","#66CC00"), name="Perturbation") +
  scale_shape_manual(values=c(17,15), name="Consumers") 

sum_Func
```

Want to run t-tests for each combination of metric x treatment

try for one...
```{r}
test<-contributions %>% 
  group_by(metric, Treatment) %>% 
  summarise(pval = t.test(x = LRR_metric, mu = 0)$p.value, 
            tval = t.test(x = LRR_metric, mu = 0)$statistic)


contributions %>% 
  filter(metric == "Resilience", Treatment== "A_N0_S1")%>% 
  summarise(pval = t.test(x = LRR_metric, mu = 0)$p.value, 
            tval = t.test(x = LRR_metric, mu = 0)$statistic)

test

```

